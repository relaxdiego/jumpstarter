#!/usr/bin/env bash
set -e

config_dir=$(pwd)/$1

script_path=$(dirname "${BASH_SOURCE[0]}")
source $script_path/common > /dev/null

cd $configurator_dir

if [ -e "jumpbox.retry" ]; then
    RETRY="--limit @jumpbox.retry"
else
    RETRY=""
fi

machine_ip=$(terraform output -state=$config_dir/terraform.tfstate IP)
ansible-playbook $RETRY --inventory="${config_dir}/hosts.yml" --extra-vars="ansible_ssh_user=ubuntu" jumpbox.yaml
rm -f *.retry
